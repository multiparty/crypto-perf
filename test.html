<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>
<script>
  var privateKey, publicKey, keyPair, pem, foo;

  window.crypto.subtle.generateKey({
    name: "RSA-OAEP",
    modulusLength: 2048,
    publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
    hash: {name: "SHA-256"}
  }, true, ["encrypt", "decrypt"])
    .then(function (keyP) {
      keyPair = keyP;
      return window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
      //return window.crypto.subtle.exportKey("jwk", keyPair.privateKey);
    })
    .then(function (privateK) {
      privateKey = privateK;
      console.log("private key native", arrayBufferToBase64String(privateKey));
      //var buffer = new forge.util.ByteBuffer(privateKey);
      //var asn1 = forge.asn1.fromDer(buffer);
      var privateKey2 = forge.pki.privateKeyFromPem(toPem(arrayBufferToBase64String(privateKey), true));
      pem = forge.pki.privateKeyToPem(privateKey2);
      console.log("private key forge", privateKey2);
      return window.crypto.subtle.exportKey("spki", keyPair.publicKey);
    })
    .then(function (publicK) {
      publicKey = publicK;
      console.log("public key", arrayBufferToBase64String(publicKey));

      var pub = forge.pki.publicKeyFromPem(toPem(arrayBufferToBase64String(publicKey)));
      foo = btoa(pub.encrypt('testing123', 'RSA-OAEP', {
        md: forge.md.sha256.create()
      }));

      return window.crypto.subtle.encrypt({name: "RSA-OAEP"}, keyPair.publicKey, new TextEncoder('utf-8').encode("test"))
    })
    .then(function (result) {
      console.log("encrypted", arrayBufferToBase64String(result));


      //     		var buffer = new forge.util.ByteBuffer(publicKey);
      //   			var asn1 = forge.asn1.fromDer(buffer);
      //   			var publicKey2 = forge.pki.publicKeyFromAsn1(asn1);
      //   			var pem2 = forge.pki.publicKeyToPem(publicKey2);

      //         	var rsa_pub = forge.pki.publicKeyFromPem(pem2);
      // var encrypted = rsa_pub.encrypt("test", 'RSA-OAEP');
      // console.log("public key forge", pem2);

      var key = forge.pki.privateKeyFromPem(pem);
      var decrypted = key.decrypt(foo, 'RSA-OAEP', {md: forge.md.sha256.create()});
      console.log('forge decode', decrypted);
      var enc = new TextEncoder();

      return window.crypto.subtle.decrypt({name: "RSA-OAEP"}, keyPair.privateKey, str2ab(atob(foo)));
    })
    .then(function (result) {
      console.log(arrayBufferToString(result));
    });
</script>

<script>
  //       var key = arrayBufferToBase64String(jwk);
  //       //console.log(key);
  //       b64ToArrayBuffer(pub).then(function(b64) {
  //           window.crypto.subtle.importKey(
  //                   "spki", //can be "jwk" (public or private), "spki" (public only), or "pkcs8" (private only)
  //                   b64, { //these are the algorithm options
  //                       name: "RSA-OAEP",
  //                       hash: {
  //                           name: "SHA-256"
  //                       } //can be "SHA-1", "SHA-256", "SHA-384", or "SHA-512"
  //                   },
  //                   false, //whether the key is extractable (i.e. can be used in exportKey)
  //                   ["encrypt"] //"encrypt" or "wrapKey" for public key import or
  //                   //"decrypt" or "unwrapKey" for private key imports
  //               )
  //               .then(function(privateKey) {
  //                   //returns a publicKey (or privateKey if you are importing a private key)
  //                   console.log(privateKey);

  //                   window.crypto.subtle.encrypt({
  //     name: "RSA-OAEP",
  //     //label: Uint8Array([...]) //optional
  // 	},
  // 	privateKey,
  // 	enc.encode("test")
  // ).
  //                   then(function (result) {
  //                   	console.log(arrayBufferToBase64String(new Uint8Array(result)));
  //                   })

  //                     b64ToArrayBuffer(val).then(function (b64) {
  // window.crypto.subtle.decrypt({
  //                                 name: "RSA-OAEP"
  //                                     //label: Uint8Array([...]) //optional
  //                             },
  //                             privateKey, //from generateKey or importKey above
  //                             b64 //ArrayBuffer of the data
  //                         )
  //                         .then(function(decrypted) {
  //                             //returns an ArrayBuffer containing the decrypted data
  //                             return decrypted;
  //                         })
  //                         .catch(function(err) {
  //                             console.error(err);
  //                         });
  //                     });

  //});
  //});

  //});
</script>

</body>
</html>
